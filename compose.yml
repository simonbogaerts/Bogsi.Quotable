name: bogsi-quotable

services:
  web:
    build: 
      context: .
      dockerfile: Dockerfile
    image: bogsi-quotable-web:latest
    container_name: web
    environment:
      ASPNETCORE_ENVIRONMENT: Production
    networks:
      - quotable-network
    ports:
      - 8080:8080
      - 8081:8081
    depends_on:
      - database
      - logging
      - caching
      - messaging
  
  database:
    image: postgres:17rc1-alpine3.20
    container_name: database 
    restart: always
    environment:
      POSTGRES_USER: quotable
      POSTGRES_PASSWORD: quotable123
      POSTGRES_DB: quotable-db
    ports:
      - 5432:5432
    volumes:
      - ./.container-data/db:/var/lib/postgresql/data
    networks:
      - quotable-network

  logging:
    image: datalust/seq:latest
    container_name: logging 
    restart: always
    environment:
      ACCEPT_EULA: Y
    ports:
      - 5341:5341
      - 8082:80
    volumes:
      - ./.container-data/seq:/data
    networks:
      - quotable-network

  caching:
    image: valkey/valkey:8.0.1-alpine
    container_name: caching 
    restart: always
    command: valkey-server /etc/valkey/valkey.conf --save 60 1 --loglevel warning
    volumes:
      - ./.container-data/valkey/conf:/etc/valkey/valkey.conf
      - ./.container-data/valkey/data:/data
    ports:
      - 6379:6379
    networks:
      - quotable-network

  messaging:
    image: rabbitmq:management
    container_name: messaging
    hostname: messaging
    restart: always
    volumes:
      - ./.container-data/queue/data:/var/lib/rabbitmq
      - ./.container-data/queue/logs:/var/log/rabbitmq
    ports:
      - 5672:5672
      - 15672:15672
    environment:
      RABBITMQ_DEFAULT_USER: quotable
      RABBITMQ_DEFAULT_PASS: quotable
    networks:
      - quotable-network

networks:
  quotable-network:
